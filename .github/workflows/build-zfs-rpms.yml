name: Build OpenZFS RPMs

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      zfs_version:
        description: 'OpenZFS version to build (e.g., 2.2.8)'
        required: true
        default: '2.2.8'

jobs:
  build:
    permissions:
      id-token: write
      contents: write
    runs-on: [self-hosted, ORCD-StorEC2]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Resolve ZFS version
        run: |
          if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
            echo "ZFS_VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_ENV"
          else
            echo "ZFS_VERSION=${{ inputs.zfs_version }}" >> "$GITHUB_ENV"
          fi

      - name: Install Apptainer
        run: |
          sudo dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm
          sudo dnf install -y apptainer squashfs-tools wget

      - name: Download container if not built
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: container-image
          path: .

      - name: Ensure container exists
        run: |
          if [ ! -f rhel9.sif ]; then
            sudo apptainer build rhel9.sif definitions/rhel9.def
          fi

      - name: Download ZFS source
        run: |
          wget https://github.com/openzfs/zfs/releases/download/zfs-${ZFS_VERSION}/zfs-${ZFS_VERSION}.tar.gz
          tar -xzf zfs-${ZFS_VERSION}.tar.gz

      - name: Build RPMs in container
        run: |
          apptainer exec --writable-tmpfs --fakeroot --bind "${GITHUB_WORKSPACE}:/workspace" rhel9.sif bash -c "
            cd /workspace/zfs-${ZFS_VERSION}
            ./configure --with-config=user
            make -j$(nproc) rpm
          "

      - name: Collect RPM artifacts
        run: |
          mkdir -p artifacts
          shopt -s globstar nullglob
          cp /tmp/zfs-build-*/RPMS/**/*.rpm artifacts/

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zfs-rpms
          path: artifacts/*.rpm

      - name: Create GitHub release
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.rpm
